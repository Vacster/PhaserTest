<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Phaser Test!</title>
        <script src="/phaser.js"></script>
    </head>

    <body style="background-color:black">
      <div id="gamediv" style="width:85%; height:100%; margin:auto"></div>
    </body>

    <script type="text/javascript">
    document.getElementById("gamediv").oncontextmenu = function (e) {e.preventDefault();};

    window.onload = function() {
        const horizontal_step = 0.5;
        const max_acc = 15;
        const upper_bound = 1180;
        const lower_bound = 100;
        const game = new Phaser.Game(1280, 720, Phaser.AUTO, 'gamediv', { preload: preload, create: create, update: update, render: render });

        var rocks;
        var mouse, plane;
        var acc = 0;

        function preload ()
        {
          game.load.spritesheet('plane', 'airplane.png', 200, 200, 25);
          game.load.image('rock', 'rock.png');
          game.input.mouse.capture = true;
        }

        function create ()
        {
          game.scale.scaleMode = Phaser.ScaleManager.SHOW_ALL;
          game.scale.pageAlignHorizontally = true;
          game.scale.pageAlignVertically = true;

          plane = game.add.sprite(game.world.centerX, game.world.height * 0.8, 'plane');
          plane.anchor.x = 0.5;
          plane.anchor.y = 0.5;

          rocks = game.add.group();
        }

        function update ()
        {
          mouse = game.input.activePointer;

          if(plane.x < lower_bound)
          {
            plane.x = lower_bound;
            acc = 0;
            spawn_rock();
          }
          else if(plane.x > upper_bound)
          {
            plane.x = upper_bound;
            acc = 0;
            restart();
          }

          acc += mouse.isDown ? (acc > - max_acc ? - horizontal_step : 0) : (acc < max_acc ? horizontal_step : 0);

          plane.x += acc;

          update_rocks();
          determineFrame();
        }

        function render()
        {
          game.debug.spriteInfo(plane, plane.x <= game.world.width/2 ? plane.x + 100 : plane.x - 450, plane.y - 100);
          game.debug.text("Acceleration: " + acc, 32, 32);
          game.debug.text("Frame: " + plane.frame, 32, 50);
          game.debug.text("Rocks Spawned: " + rocks.length, 32, 68);
        }

        function determineFrame()
        {
          if(acc > 13)
            plane.frame = 4;
          else if(acc > 4)
            plane.frame = 3;
          else if(acc < -13)
            plane.frame = 0;
          else if(acc < -4)
            plane.frame = 1;
          else
            plane.frame = 2;
        }

        function restart()
        {
          acc = 0;
          plane.x = game.world.width/2;
          plane.frame = 2;
          rocks.removeAll(true, false);
        }

        function update_rocks()
        {
          rocks.forEach(function(rock, index, object){
            if(rock.y > 720 + (rock.height/2))
            {
              rock.destroy();
            }
            else
            {
              rock.y += 5;
              rock.angle += 5;
            }
          });
        }

        function spawn_rock()
        {
          var rock = rocks.create(Math.random() * (upper_bound - lower_bound) + lower_bound, 0, 'rock');
          rock.anchor.x = 0.5;
          rock.anchor.y = 0.5;
        }
    };

    </script>
</html>
