<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Phaser Test!</title>
        <script src="/phaser.js"></script>
    </head>

    <body style="background-color:black">
      <div id="gamediv" style="width:85%; height:100%; margin:auto"></div>
    </body>

    <script type="text/javascript">
    document.getElementById("gamediv").oncontextmenu = function (e) {e.preventDefault();};

    var urlParams;

    window.onload = function() {
        const horizontal_step = 0.5;
        const max_acc = 15;
        const upper_bound = 1180;
        const lower_bound = 100;
        const game = new Phaser.Game(1280, 720, Phaser.AUTO, 'gamediv', { preload: preload, create: create, update: update, render: render });

        var started = false;
        var rocks;
        var mouse, plane;
        var acc = 0;
        var health = 3;
        var emitter;

        function preload ()
        {
          game.load.spritesheet('plane', 'airplane.png', 200, 200, 25);
          game.load.image('rock', 'rock.png');
          game.load.image('fire', 'rock.png');
          game.input.mouse.capture = true;
        }

        function create ()
        {
          game.scale.scaleMode = Phaser.ScaleManager.SHOW_ALL;
          game.scale.pageAlignHorizontally = true;
          game.scale.pageAlignVertically = true;

          plane = game.add.sprite(game.world.centerX, game.world.height * 0.8, 'plane');
          game.physics.enable(plane, Phaser.Physics.ARCADE);
          plane.anchor.x = 0.5;
          plane.anchor.y = 0.5;
          plane.frame = 2;
          plane.body.setSize(180, 80, 10, 60);

          rocks = game.add.group();

          emitter = game.add.emitter(50, 50, 200);
          emitter.makeParticles('fire');
          emitter.minParticleScale = 0.02;
          emitter.maxParticleScale = 0.3;
          emitter.minParticleSpeed.set(-500, -500);
          emitter.maxParticleSpeed.set(500, 500);
          emitter.setAlpha(1, 0, 1500);

          setInterval(spawn_rock, 900);
          getUrlParams();
        }

        function update ()
        {
          mouse = game.input.activePointer;

          if(started)
          {
            if(plane.x < lower_bound)
            {
              plane.x = lower_bound;
              acc = 0;
            }
            else if(plane.x > upper_bound)
            {
              plane.x = upper_bound;
              acc = 0;
            }

            acc += mouse.isDown ? (acc > - max_acc ? - horizontal_step : 0) : (acc < max_acc ? horizontal_step : 0);

            plane.x += acc;

            update_rocks();
          }
          else
            if(mouse.isDown)
              started = true;

          determineFrame();
        }

        function render()
        {
          if(urlParams["debug"] == 'true')
          {
            game.debug.body(plane);
            rocks.forEach(function(rock, index, object){
              game.debug.body(rock);
            });
            game.debug.spriteInfo(plane, plane.x <= game.world.width/2 ? plane.x + 100 : plane.x - 450, plane.y - 100);
            game.debug.text("Acceleration: " + acc, 32, 32);
            game.debug.text("Health: " + health, 32, 50);
            game.debug.text("Rocks Spawned: " + rocks.length, 32, 68);
          }
        }

        function determineFrame()
        {
          plane.angle = acc * 2;
        }

        function update_rocks()
        {
          rocks.forEach(function(rock, index, object){
            if(rock.y > 720 + (rock.height/2))
              rock.destroy();
            else
            {
              rock.y += 5;
              rock.angle += 5;
              if(game.physics.arcade.collide(rock, plane))
              {
                game.camera.shake(0.005, 500);
                emitter.x = rock.x;
                emitter.y = rock.y;
                emitter.start(true, 1500, null, 20);
                rock.destroy();
                //TODO: Modify acc on hit
                health -= 1;
                if(health == 0)
                  restart();
              }
            }
          });
        }

        function spawn_rock()
        {
          if(!started || !document.hasFocus())
            return;
          var rock = rocks.create(Math.random() * 1080 + 100, 0, 'rock');
          game.physics.enable(rock, Phaser.Physics.ARCADE);
          rock.body.setCircle(90, 0, 10);
          rock.anchor.x = 0.5;
          rock.anchor.y = 0.5;
          rock.angle = Math.random() * 360;
        }

        function restart()
        {
          started = false;
          acc = 0;
          health = 3;
          plane.x = game.world.width/2;
          rocks.removeAll(true, false);
        }

        function getUrlParams()
        {
          var match,
              pl     = /\+/g,  // Regex for replacing addition symbol with a space
              search = /([^&=]+)=?([^&]*)/g,
              decode = function (s) { return decodeURIComponent(s.replace(pl, " ")); },
              query  = window.location.search.substring(1);

          urlParams = {};
          while (match = search.exec(query))
             urlParams[decode(match[1])] = decode(match[2]);
        }
    };

    </script>
</html>
